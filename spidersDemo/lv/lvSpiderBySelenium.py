from typing import Iterable
import scrapy
from scrapy import Request
# from scrapy_redis.spiders import RedisSpider
from scrapySpiderRedis.items import LvItem
from scrapySpiderRedis.log import Logging
from gerapySelenium import SeleniumRequest
from scrapy.http import HtmlResponse, Response
import re
# taskkill /f /im chrome.exe å…³é—­æ‰€æœ‰è°·æ­Œæµè§ˆ
# taskkill /f /im chromedriver.exe  å…³é—­è°·æ­Œé©±åŠ¨

class lvSpiderBySelenium(scrapy.Spider):
    name = "lvSpiderBySelenium"
    allowed_domains = ["ctrip.com"]
    # æ­å·ã€å®æ³¢ã€æ¸©å·ã€å˜‰å…´ã€æ¹–å·ã€ç»å…´ã€é‡‘åã€è¡¢å·ã€èˆŸå±±ã€å°å·ã€ä¸½æ°´
    # æ­å· https://vacations.ctrip.com/list/grouptravel/sc17.html?st=%E5%A2%83%E5%86%85&startcity=17&sv=%E5%A2%83%E5%86%85&p={} cityId=17 page 100
    # å®æ³¢ https://vacations.ctrip.com/list/grouptravel/sc375.html?st=%E5%A2%83%E5%86%85&startcity=375&sv=%E5%A2%83%E5%86%85&p={} citycode 375 page 100
    # æ¸©å· https://vacations.ctrip.com/list/grouptravel/sc491.html?st=%E5%A2%83%E5%86%85&startcity=491&sv=%E5%A2%83%E5%86%85&p={} code 491
    # å˜‰å…´ https://vacations.ctrip.com/list/grouptravel/sc571.html?st=%E5%A2%83%E5%86%85&startcity=571&sv=%E5%A2%83%E5%86%85&p={} code 571
    start_urls = [{"url":"https://vacations.ctrip.com/list/grouptravel/sc308.html?p={}&st=%E6%B5%99%E6%B1%9F&startcity=308&sv=%E6%B5%99%E6%B1%9F","page":100,"from_city_code":308}]
    # start_url="https://www.baidu.com"
    logger = Logging("lvSpiderBySelenium.log").get_logger() # ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—å™¨

    def start_requests(self) -> Iterable[Request]:
        for item in self.start_urls:
            # ä¸‹é¢çš„rangeå¿˜æ‰äº†ï¼Œæˆ‘çœŸæƒ³ç»™è‡ªå·±ä¸¤å·´æŒ
            for page in range(1,item["page"]+1):
                try:
                    self.logger.info(f"å½“å‰é¡µç æ˜¯"+str({item["url"].format(page)}))
                    yield SeleniumRequest(url=item["url"].format(page),callback=self.parse_detail_list,meta={"from_city_code":item["from_city_code"],"page":page},sleep=3)
                except Exception as error:
                    self.logger.error(f"ç¿»é¡µå‡ºç°é”™è¯¯ï¼Œé”™è¯¯åŸå› æ˜¯{error}")
    def parse_detail_list(self, response:HtmlResponse):
        # <div class="list_product_box js_product_item" data-track-product-id="1930186" data-track-is-recommend="false" data-track-inner-pos="5" style="position:relative"><div class="list_product_item_border"><div class="list_product_item flex flex-row"><div class="list_product_left" style="margin-right:16px"><div class="bg-gray-skeleton" style="width:100%;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);height:100%"></div><img class="list_product_pic" src="//dimg04.c-ctrip.com/images/0304u12000dshin6kE045_C_420_420.jpg" style="width:210px;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%)" alt="åä¸œ5å¸‚+ä¹Œé•‡5æ—¥4æ™šè·Ÿå›¢æ¸¸" title="åä¸œ5å¸‚+ä¹Œé•‡5æ—¥4æ™šè·Ÿå›¢æ¸¸" loading="lazy"><p class="list_product_tip truncate" style="max-width:150px"><span class="list_product_name">è·Ÿå›¢æ¸¸</span><i class="list_product_heng"></i><span class="list_product_place">é‡‘åå‡ºå‘</span></p></div><div class="list_product_right" style="flex:1;width:1%;min-height:150px"><p class="list_product_title" title="åä¸œ5å¸‚+ä¹Œé•‡5æ—¥4æ™šè·Ÿå›¢æ¸¸"><span>åä¸œ5å¸‚+ä¹Œé•‡5æ—¥4æ™šè·Ÿå›¢æ¸¸</span><img src="//pic.c-ctrip.com/VacationOnlinePic/tourpic/group_travel/list/diamond_4.png" alt="4é’»" style="height: 16px; padding-left: 4px; margin-bottom: -2px;"></p><p class="list_product_subtitle" title="ã€æºç¨‹è‡ªè¥Â·æ•æ°´æ±Ÿå—ã€‘<é™æ—¶èµ >ä¸€ç“¶èŒ‰è‰&amp;æ–‡åˆ›é›ªç³• å‡çº§2æ™š5é’»&amp;å®¿ä¹Œé•‡ï¼Œçµå±±ç¥ˆç¦&amp;æ¢µå®«è‡ªåŠ©+4æ­£é«˜é¤æ ‡50Â·å“å¾¡èŒ¶å®´&amp;åŒæ°´ä¹¡ä¹Œé•‡+å‘¨åº„èµ æ™¯äº¤+è¥¿æ¹–æ¸¸èˆ¹+ç•™å›­ã€çº¯ç©æ— è´­ç‰©ã€‘å—äº¬è¿›ä¸Šæµ·å‡º|å«å¤§äº¤é€š">ã€æºç¨‹è‡ªè¥Â·æ•æ°´æ±Ÿå—ã€‘&lt;é™æ—¶èµ &gt;ä¸€ç“¶èŒ‰è‰&amp;æ–‡åˆ›é›ªç³• å‡çº§2æ™š5é’»&amp;å®¿ä¹Œé•‡ï¼Œçµå±±ç¥ˆç¦&amp;æ¢µå®«è‡ªåŠ©+4æ­£é«˜é¤æ ‡50Â·å“å¾¡èŒ¶å®´&amp;åŒæ°´ä¹¡ä¹Œé•‡+å‘¨åº„èµ æ™¯äº¤+è¥¿æ¹–æ¸¸èˆ¹+ç•™å›­ã€çº¯ç©æ— è´­ç‰©ã€‘å—äº¬è¿›ä¸Šæµ·å‡º|å«å¤§äº¤é€š</p><div class="list_label_box"><span class="list_label_blue" title="å…¨ç¨‹ä¸å«è´­ç‰©åº—è¡Œç¨‹ï¼ˆDFSã€è€ä½›çˆ·ç­‰å…¨çƒçŸ¥åç™¾è´§åŠæ™¯åŒºæ™¯ç‚¹åŠé‚®è½®å†…ç­‰éæºç¨‹å•†å®¶ç»„ç»‡çš„è´­ç‰©ä¸åŒ…æ‹¬åœ¨å†…ï¼‰ï¼Œæ— ä»»ä½•è´­ç‰©å¼ºåˆ¶æ¶ˆè´¹"><span>æ— è´­ç‰©</span></span><span class="list_label_blue" title="è®¢å•ä¸€ç»æºç¨‹æ—…è¡Œç½‘ä»¥ä¹¦é¢å½¢å¼ç¡®è®¤åå‡é»˜è®¤å‘å›¢ï¼ˆä¸å¯æŠ—åŠ›é™¤å¤–ï¼‰"><span>æˆå›¢ä¿éšœ</span></span><span class="list_label_blue" title="æ‹¿å»èŠ±3æœŸå…æ¯"><span>3æœŸå…æ¯</span></span><span class="list_label_blue" title="çº¿è·¯ç‰¹è‰²"><span>å®«æ®¿</span></span><span class="list_label_blue" title="ç‰¹è‰²é¡¹ç›®"><span>å¯ºé™¢ç¥ˆç¦</span></span></div><div class="list_tiny_comment_box"><span class="list_product_score"><span>4.9</span>åˆ†</span><span class="list_product_travel">å·²å”®14019äºº</span><span class="list_travel_comment_separator"></span><span class="list_product_comment">4211æ¡ç‚¹è¯„</span></div><div class="flex flex-col"><div class="absolute"><p class="list_product_retail">ä¾›åº”å•†ï¼š<span class="list_container_supplier_special"><i class="list_icon_yoyo">î‚®</i>æºç¨‹è‡ªè¥</span></p></div><div class="flex flex-col"><div class="list_sr_price_box basefix relative"><div class="list_sr_price"><dfn>ï¿¥</dfn><strong>1276</strong>èµ·</div><div><div class="list_pricetag_container"><span class="list_pricetag_label list_pricetag_label_first">é™æ—¶ä¿ƒé”€</span><span class="list_pricetag_display"><span>å·²å‡150</span></span></div></div></div></div></div></div></div></div></div>
        detail_list = response.css('div.list_product_box.js_product_item')
        count=0
        for detail_item in detail_list:
            try:
                self.logger.info(f"å½“å‰é¡µç æ˜¯"+str(response.meta["page"]))
                count=count+1
                self.logger.info(f"å½“å‰çˆ¬å–äº†æ”¹é¡µé¢ç¬¬{count}ä¸ªæ—…æ¸¸å›¢")
                
                # <span class="list_product_place">é‡‘åå‡ºå‘</span>
                # departure_place = (re.search(r'<span class="list_product_place">(.*?)</span>', detail_item.css('.list_product_place').get()).group(1)  if detail_item.css('.list_product_place').get() is not None else "").replace("å‡ºå‘","") # å‡ºå‘åœ°
                departure_place = (detail_item.css('.list_product_place::text').get()).replace("å‡ºå‘","") # å‡ºå‘åœ°
                
                # <p class="list_product_title" title="åä¸œ5å¸‚+ä¹Œé•‡5æ—¥4æ™šè·Ÿå›¢æ¸¸"><span>åä¸œ5å¸‚+ä¹Œé•‡5æ—¥4æ™šè·Ÿå›¢æ¸¸</span><img src="//pic.c-ctrip.com/VacationOnlinePic/tourpic/group_travel/list/diamond_4.png" alt="4é’»" style="height: 16px; padding-left: 4px; margin-bottom: -2px;"></p>
                title = detail_item.css('p.list_product_title span::text').getall()[-1] if len(detail_item.css('p.list_product_title span::text').getall())>0 else ""
                
                # <div class="list_sr_price"><dfn>ï¿¥</dfn><strong>1276</strong>èµ·</div>
                price = detail_item.css('div.list_sr_price strong::text').get().strip() if detail_item.css('div.list_sr_price strong::text').get() is not None else ""

                # <div class="list_product_box js_product_item" data-track-product-id="32800390" data-track-is-recommend="false" data-track-inner-pos="2" style="position:relative"><div class="list_product_item_border"><div class="list_product_item flex flex-row"><div class="list_product_left" style="margin-right:16px"><div class="bg-gray-skeleton" style="width:100%;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);height:100%"></div><img class="list_product_pic" src="//dimg04.c-ctrip.com/images/100b0v000000k5fkx7586_C_420_420.jpg" style="width:210px;position:absolute;top:50%;left:50%;transform:translate(-50%, -50%)" alt="é‡‘ååŒé¾™é£æ™¯æ—…æ¸¸åŒº+è¯¸è‘›å…«å¦æ‘+é¾™æ¸¸çŸ³çªŸ2æ—¥1æ™šç§å®¶å›¢" title="é‡‘ååŒé¾™é£æ™¯æ—…æ¸¸åŒº+è¯¸è‘›å…«å¦æ‘+é¾™æ¸¸çŸ³çªŸ2æ—¥1æ™šç§å®¶å›¢" loading="eager"><p class="list_product_tip truncate" style="max-width:150px"><span class="list_product_name">ç§å®¶å›¢</span><i class="list_product_heng"></i><span class="list_product_place">é‡‘åå‡ºå‘</span></p></div><div class="list_product_right" style="flex:1;width:1%;min-height:150px"><p class="list_product_title" title="é‡‘ååŒé¾™é£æ™¯æ—…æ¸¸åŒº+è¯¸è‘›å…«å¦æ‘+é¾™æ¸¸çŸ³çªŸ2æ—¥1æ™šç§å®¶å›¢"><span>é‡‘ååŒé¾™é£æ™¯æ—…æ¸¸åŒº+è¯¸è‘›å…«å¦æ‘+é¾™æ¸¸çŸ³çªŸ2æ—¥1æ™šç§å®¶å›¢</span><img src="//pic.c-ctrip.com/VacationOnlinePic/tourpic/group_travel/list/diamond_5.png" alt="5é’»" style="height: 16px; padding-left: 4px; margin-bottom: -2px;"></p><p class="list_product_subtitle" title="ã€å¯ŒåŠ›ä¸‡è¾¾å˜‰åé…’åº—/é›·è¿ªæ£®å¹¿åœºé…’åº—Â·40å¹³å¤§æˆ¿é—´Â·å¸‚åŒºå•†ä¸šä¸­å¿ƒã€‘æ±Ÿä¸œé“æ•™åå±±+åŒé¾™æ´å¥‡æ´å¼‚æ™¯+æ°´çŸ³å¥‡è§‚+è¯¸è‘›æ‘å¤å»ºç­‘+é¾™æ¸¸å¤§å‹åœ°ä¸‹å»ºç­‘ç¾¤Â·ä¸“è½¦Â·äº²å­Â·æƒ…ä¾£">ã€å¯ŒåŠ›ä¸‡è¾¾å˜‰åé…’åº—/é›·è¿ªæ£®å¹¿åœºé…’åº—Â·40å¹³å¤§æˆ¿é—´Â·å¸‚åŒºå•†ä¸šä¸­å¿ƒã€‘æ±Ÿä¸œé“æ•™åå±±+åŒé¾™æ´å¥‡æ´å¼‚æ™¯+æ°´çŸ³å¥‡è§‚+è¯¸è‘›æ‘å¤å»ºç­‘+é¾™æ¸¸å¤§å‹åœ°ä¸‹å»ºç­‘ç¾¤Â·ä¸“è½¦Â·äº²å­Â·æƒ…ä¾£</p><div class="list_label_box"><span class="list_label_blue" title="é¡¹ç›®ç±»æ ‡ç­¾"><span>å«æ¥é€æœº/ç«™</span></span><span class="list_label_blue" title="å…¨ç¨‹ä¸å«è´­ç‰©åº—è¡Œç¨‹ï¼ˆDFSã€è€ä½›çˆ·ç­‰å…¨çƒçŸ¥åç™¾è´§åŠæ™¯åŒºæ™¯ç‚¹åŠé‚®è½®å†…ç­‰éæºç¨‹å•†å®¶ç»„ç»‡çš„è´­ç‰©ä¸åŒ…æ‹¬åœ¨å†…ï¼‰ï¼Œæ— ä»»ä½•è´­ç‰©å¼ºåˆ¶æ¶ˆè´¹"><span>æ— è´­ç‰©</span></span><span class="list_label_blue" title="å…¨ç¨‹ä¸æ¨èã€ä¸å¼ºåˆ¶ä»»ä½•è‡ªè´¹é¡¹ç›®ï¼ˆæ™¯åŒºæ™¯ç‚¹åŠé‚®è½®å†…ç­‰éæºç¨‹å•†å®¶ç»„ç»‡çš„è‡ªè´¹è¡Œä¸ºä¸åŒ…æ‹¬åœ¨å†…ï¼‰"><span>æ— è‡ªè´¹</span></span><span class="list_label_blue" title="è®¢å•ä¸€ç»æºç¨‹æ—…è¡Œç½‘ä»¥ä¹¦é¢å½¢å¼ç¡®è®¤åå‡é»˜è®¤å‘å›¢ï¼ˆä¸å¯æŠ—åŠ›é™¤å¤–ï¼‰"><span>æˆå›¢ä¿éšœ</span></span><span class="list_label_blue" title="çº¿è·¯ç‰¹è‰²"><span>çŸ³çªŸ</span></span><span class="list_label_blue" title="ç‰¹è‰²é¡¹ç›®"><span>å¤é•‡å¤æ‘</span></span><span class="list_label_blue" title="ç‰¹è‰²é¡¹ç›®"><span>è½¦å‹å¯é€‰</span></span><span class="list_label_blue" title="é…’åº—ç‰¹è‰²"><span>è‡ªé€‰é…’åº—</span></span></div><div class="list_tiny_comment_box"><span class="list_product_travel">å·²å”®4äºº</span></div><div class="flex flex-col"><div class="absolute"><p class="list_product_retail">ä¾›åº”å•†ï¼šé£æ™¯æ—…æ¸¸</p></div><div class="flex flex-col"><div class="list_sr_price_box basefix relative"><div class="list_sr_price"><dfn>ï¿¥</dfn><strong>1620</strong>èµ·</div></div></div></div></div></div></div></div>
                detail_id = detail_item.css('div.list_product_box.js_product_item::attr(data-track-product-id)').get()
                from_city_code=response.meta["from_city_code"]
                detail_url=f"https://vacations.ctrip.com/travel/detail/p{detail_id}?city={from_city_code}&rv=1"
                
                yield SeleniumRequest(url=detail_url,sleep=5,pretend=True,script="""document.querySelector('[id*="pkg-tab-æ¯æ—¥è¡Œç¨‹"]')?.click() || document.querySelector('[id*="schedule-switch-1"]')?.click();""", wait_for=".mult_cale_table",meta={"departure_place":departure_place,"title":title,"price":price,"detail_url":detail_url,"page":str(response.meta["page"])},callback=self.parse_detail)
            except Exception as error:
                self.logger.error(f"è§£æè¯¦æƒ…åˆ—è¡¨é¡µé”™è¯¯,é”™è¯¯åŸå› æ˜¯{error}")
                continue
       
        
    def parse_detail(self, response:HtmlResponse):
        try:
            self.logger.info(f"å½“å‰é¡µé¢çš„é¡µé¢æ˜¯: "+ str(response.meta["page"]))
            if response.css('.from_city::text').get():
                detail_departure_place = response.css('.from_city::text').get().strip().split("ï¼š")[1].split("(")[0]
            elif response.css('.prd_num::text').get():
                detail_departure_place = response.css('.prd_num::text').get().strip().split("ï¼š")[1].split("(")[0]
            
            if response.xpath('//span[@class="rich_content_view_20191129 total_price"]/em/text()').get():
                detail_price=response.xpath('//span[@class="rich_content_view_20191129 total_price"]/em/text()').get()
            
            # <div class="mult_cale" id="js_schedule_calendar_table"><table class="mult_cale_table"><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"></colgroup><tbody><tr><th>è¡Œç¨‹</th><th>ç”¨é¤</th><th>æ™¯ç‚¹/åœºé¦†&amp;æ´»åŠ¨</th><th>é…’åº—</th></tr><tr class="js_scheduleItemCalendar"><td><h3>ç¬¬1å¤©</h3><p>å«å…è´¹ä¸Šæµ·æ¥æœº/ç«™æœåŠ¡ï¼ˆè™¹æ¡¥æœºåœº/è™¹æ¡¥é«˜é“ç«™/æµ¦ä¸œæœºåœºï¼‰-ï¼ˆå…è´¹è¡Œæå¯„å­˜Â·æ¸¸å®¢æœåŠ¡ä¸­å¿ƒï¼‰-è‡ªç”±æ´»åŠ¨-é€è‡³é…’åº—â€”â€”å®¿ä¸Šæµ·</p></td><td><div><div><p><span class="rich_content_view_20191129 ">åˆé¤ï¼š</span></p><p><span class="rich_content_view_20191129 ">æˆäººä¸å«é¤ï¼Œå„¿ç«¥ä¸å«é¤</span></p><p><span>å½“åœ°ç¾é£Ÿæ¨èï¼š<a href="//you.ctrip.com/food/2/12614475.html" target="_blank">è’‹è£å…´å¤–æ»©æ±¤åŒ…(é»„æµ¦æ·æ´¾åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/12308820.html" target="_blank">å“ˆçµé¢é¦†(å¹¿è¥¿åŒ—è·¯åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/78133922.html" target="_blank">æ²ªè¥¿è€å¼„å ‚é¢é¦†(å¹¿ä¸œè·¯åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/7511005.html" target="_blank">è€æ­£å’Œ</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/314198.html" target="_blank">å¾·å…´é¦†(å¹¿ä¸œè·¯æ€»åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/15261731.html" target="_blank">åº„æ°éš†å…´Â·èŸ¹æ¨½å°ç¬¼(å¤–æ»©åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/4994197.html" target="_blank">å…‰æ˜é‚¨å¤§é…’å®¶</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/12820939.html" target="_blank">è€ç‘ç¦ä¸Šæµ·èœé¤å…(äººæ°‘å¹¿åœºåº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/121670096.html" target="_blank">æ²ˆå¤§æˆ(åŸéšåº™åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/2/136437895.html" target="_blank">å›½é™…é¥­åº—è´è¶é…¥(æ·®æµ·ä¸­è·¯åº—)</a></span></p></div><div><p><span class="rich_content_view_20191129 ">æ™šé¤ï¼š</span></p><p><span class="rich_content_view_20191129 ">æˆäººä¸å«é¤ï¼Œå„¿ç«¥ä¸å«é¤</span></p></div></div></td><td><div class="cale_spot_sec"><div><i class="icon_dot"></i><span><span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#10548698" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:0,&quot;poiid&quot;:10548698}" data-json="{&quot;GSScenicSpotID&quot;:10548698,&quot;PreName&quot;:&quot;&quot;,&quot;Name&quot;:&quot;ä¸Šæµ·åŸéšåº™é“è§‚&quot;,&quot;SuffixName&quot;:&quot;&quot;}"><a class="itinerary_sce_name">ä¸Šæµ·åŸéšåº™é“è§‚</a></span></span><span><span class="rich_content_view_20191129 ">&nbsp;æˆ–&nbsp;</span></span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#10524119" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:0,&quot;poiid&quot;:10524119}" data-json="{&quot;GSScenicSpotID&quot;:10524119,&quot;PreName&quot;:&quot;&quot;,&quot;Name&quot;:&quot;å—äº¬è·¯æ­¥è¡Œè¡—&quot;,&quot;SuffixName&quot;:&quot;&quot;}"><a class="itinerary_sce_name">å—äº¬è·¯æ­¥è¡Œè¡—</a></span></span><span><span class="rich_content_view_20191129 ">&nbsp;æˆ–&nbsp;</span></span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#75611" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:0,&quot;poiid&quot;:75611}" data-json="{&quot;GSScenicSpotID&quot;:75611,&quot;PreName&quot;:&quot;&quot;,&quot;Name&quot;:&quot;å¤–æ»©&quot;,&quot;SuffixName&quot;:&quot;&quot;}"><a class="itinerary_sce_name">å¤–æ»©</a></span></span><span><span class="rich_content_view_20191129 ">&nbsp;æˆ–&nbsp;</span></span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#75615" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:0,&quot;poiid&quot;:75615}" data-json="{&quot;GSScenicSpotID&quot;:75615,&quot;PreName&quot;:&quot;&quot;,&quot;Name&quot;:&quot;è±«å›­&quot;,&quot;SuffixName&quot;:&quot;&quot;}"><a class="itinerary_sce_name">è±«å›­</a></span></span></span></span></div><div><i class="icon_dot"></i><span><span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#75614" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:0,&quot;poiid&quot;:75614}" data-json="{&quot;GSScenicSpotID&quot;:75614,&quot;PreName&quot;:&quot;&quot;,&quot;Name&quot;:&quot;é‡‘èŒ‚å¤§å¦&quot;,&quot;SuffixName&quot;:&quot;&quot;}"><a class="itinerary_sce_name">é‡‘èŒ‚å¤§å¦</a></span></span><span><span class="rich_content_view_20191129 ">&nbsp;æˆ–&nbsp;</span></span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#10758168" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:0,&quot;poiid&quot;:10758168}" data-json="{&quot;GSScenicSpotID&quot;:10758168,&quot;PreName&quot;:&quot;&quot;,&quot;Name&quot;:&quot;æµ¦æ±Ÿæ¸¸è§ˆ&quot;,&quot;SuffixName&quot;:&quot;&quot;}"><a class="itinerary_sce_name">æµ¦æ±Ÿæ¸¸è§ˆ</a></span></span></span></span></div></div></td><td><div class="cale_htl_sec"><div><div><span><a class="itinerary_hotel_item js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-1" data-trace-keyid="177081#1#13436038" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:1,&quot;poiid&quot;:13436038}" data-json="{&quot;HotelID&quot;:13436038,&quot;HotelName&quot;:&quot;ä¸Šæµ·æ™ºå¾®ä¸–çºªé…’åº—&quot;}">ä¸Šæµ·æ™ºå¾®ä¸–çºªé…’åº—</a></span><span><span class="rich_content_view_20191129 ">&nbsp;æˆ–&nbsp;</span></span><span><a class="itinerary_hotel_item js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-1" data-trace-keyid="177081#1#107012059" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:1,&quot;poiid&quot;:107012059}" data-json="{&quot;HotelID&quot;:107012059,&quot;HotelName&quot;:&quot;ä¸Šæµ·è‹å®è¯ºå¯Œç‰¹é…’åº—&quot;}">ä¸Šæµ·è‹å®è¯ºå¯Œç‰¹é…’åº—</a></span><span><span class="rich_content_view_20191129 ">&nbsp;æˆ–&nbsp;</span></span><span><a class="itinerary_hotel_item js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-1" data-trace-keyid="177081#1#426531" data-trace-key="grp_detail_routinepoi_expo" data-trace-value="{&quot;type&quot;:1,&quot;poiid&quot;:426531}" data-json="{&quot;HotelID&quot;:426531,&quot;HotelName&quot;:&quot;ä¸Šæµ·å¤–é«˜æ¡¥å–œæ¥ç™»é…’åº—&quot;}">ä¸Šæµ·å¤–é«˜æ¡¥å–œæ¥ç™»é…’åº—</a></span></div></div><div><div class="rich_content_view_20191129 "><font color="orange">ã€æ¼«æ¸¸æ¦œå•ã€‘ï¼šæ€§ä»·æ¯”ä¼˜é€‰ï¼ŒæœåŠ¡+åœ°ç†ä½ç½®</font><br><b>ä¸Šæµ·æ™ºå¾®ä¸–çºªé…’åº—ï¼ˆä¼˜å…ˆå±…ä½ğŸ‘ï¼‰ï¼ˆ4.6åˆ†ï¼‰</b>â€”â€”å‘¨è¾¹ï¼šä¸Šæµ·è¿ªå£«å°¼åº¦å‡åŒº8.1å…¬é‡Œã€ä¸Šæµ·é‡ç”ŸåŠ¨ç‰©å›­3.85å…¬é‡Œï¼›<br><b>ä¸Šæµ·è‹å®è¯ºå¯Œç‰¹é…’åº—ï¼ˆ4.6åˆ†ï¼‰</b>â€”â€”å‘¨è¾¹ï¼šå›½é™…é©¬æˆå‰§åœº4.41å…¬é‡Œã€ä¸Šæµ·é‡ç”ŸåŠ¨ç‰©å›­4.56å…¬é‡Œã€ä¸Šæµ·è¿ªå£«å°¼åº¦å‡åŒº6.72å…¬é‡Œï¼›<br><b>ä¸Šæµ·å¤–é«˜æ¡¥å–œæ¥ç™»é…’åº—ï¼ˆ4.6åˆ†ï¼‰</b>â€”â€”å‘¨è¾¹ï¼šé«˜æ¡¥é»„æ°æ°‘å®…1.14å…¬é‡Œã€é«˜æ¡¥æ–°åŸè·å…°é£æƒ…å°é•‡1.75å…¬é‡Œã€ä¸Šæµ·å…±é’æ£®æ—å…¬å›­5.08å…¬é‡Œï¼›</div></div></div></td></tr><tr class="js_scheduleItemCalendar"><td><h3>ç¬¬2å¤©</h3><p>ã€è‹å·ã€‘å±±å¡˜è¡—orå¹³æ±Ÿè·¯â€”ç•™å›­ï¼ˆVIPå¯¼æ¸¸ä¸“é¢˜ç²¾è®²ï¼šã€Šä¸–é—åå½•Â·æ±Ÿå—å¤å…¸åå›­ç¾å­¦æ¢å¹½ã€‹ï¼‰â€”ã€ä¹Œé•‡ã€‘è¥¿æ …å¤œæ¸¸â€”â€”å®¿ä¹Œé•‡å¤–</p></td><td><div><div><p><span class="rich_content_view_20191129 ">æ—©é¤ï¼š</span></p><p><span class="rich_content_view_20191129 ">æˆäººå«é¤ï¼Œå„¿ç«¥ä¸å«é¤</span></p><p><span class="rich_content_view_20191129 ">äº«ç”¨é…’åº—æ—©ï¼ŒåŒæ—©æˆ¿å‹ï¼Œä¸å åºŠä¸å«æ—©å“¦~</span></p></div><div><p><span class="rich_content_view_20191129 ">åˆé¤ï¼š</span></p><p><span class="rich_content_view_20191129 ">æˆäººä¸å«é¤ï¼Œå„¿ç«¥ä¸å«é¤</span></p><p><span>å½“åœ°ç¾é£Ÿæ¨èï¼š<a href="//you.ctrip.com/food/11/119406279.html" target="_blank">æ±Ÿé†ªç³Ÿ</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/11/70512103.html" target="_blank">é‘«éœ‡æºÂ·è‹å¼å¤§è™¾ç”Ÿç…(æ±‡é‚»åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/11/5123655.html" target="_blank">è£é˜³æ¥¼(å±±å¡˜è¡—åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/11/135268376.html" target="_blank">ä¸‡ç¦å…´(å‡¤å‡°è¡—åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/11/22503670.html" target="_blank">é˜¿æ–‡èŸ¹é»„æ±¤åŒ…(å±±å¡˜è¡—åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/11/15507396.html" target="_blank">å­™ç››å…´å¥¥ç¶é¢é¦†(å±±å¡˜è¡—åº—)</a></span></p></div><div><p><span class="rich_content_view_20191129 ">æ™šé¤ï¼š</span></p><p><span class="rich_content_view_20191129 ">æˆäººä¸å«é¤ï¼Œå„¿ç«¥ä¸å«é¤</span></p><p><span>å½“åœ°ç¾é£Ÿæ¨èï¼š<a href="//you.ctrip.com/food/220/127685038.html" target="_blank">é”¦è®°ç³•ç‚¹é“º</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/5618939.html" target="_blank">å´å¦ˆé¦„é¥¨</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/5619054.html" target="_blank">æ»‹å•¦å•¦æ²¹ç…é“ºä¸€ä¹Œé•‡èåœä¸é¥¼</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/12742739.html" target="_blank">é€šæµé…±ç²½åº—</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/5617808.html" target="_blank">é…±é¸­åº—</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/6977351.html" target="_blank">é»˜é»˜çš„å®¶</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/11844593.html" target="_blank">ä¹Œé•‡å¿†æ±Ÿå—é¤å…(è¥¿æ …ä¸œé—¨åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/8635237.html" target="_blank">75å¹¢æ°‘å®¿ç§æˆ¿èœ</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/97173319.html" target="_blank">æ°‘å®¿16ç”²ç§æˆ¿èœ</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/11844589.html" target="_blank">æ’ç››é…’å®¶(ç¯æ²³è·¯åº—)</a><span style="display: inline-block; margin-left: 12px;"></span><a href="//you.ctrip.com/food/220/23556795.html" target="_blank">å°é•‡å¤§å¨ç§æˆ¿é¤å…</a></span></p></div></div></td><td><div class="cale_spot_sec"><div><i class="icon_dot"></i><span><span><span><span class="itinerary_sce_hover js_Expose_Point js_mapPointHook" id="grp-103047-schedule-poi-0" data-trace-keyid="177081#0#81719" 
            rows=response.css('tr.js_scheduleItemCalendar')
            # tourist_spots = []
            # for row in rows:
            #     tourist_spots+=row.css('tr.js_scheduleItemCalendar')[0].css('td:nth-child(3) div a::text').getall()
            destination_place1= response.css('.header_inner').css('a::attr(title)').getall()[-1] if len(response.css('.header_inner').css('a::attr(title)').getall())>0 else ""
            # destination_place=response.meta["title"]
            tourist_spots = [spot for row in rows for spot in row.css('tr.js_scheduleItemCalendar')[0].css('td:nth-child(3) div a::text').getall()]
            item = LvItem()
            meta:dict=response.meta
            item["departure_place"]=meta["departure_place"]  if detail_departure_place in meta["departure_place"] else detail_departure_place
            item["title"]=meta["title"]
            item["price"]= meta["price"]  if meta["price"] == detail_price else detail_price
            item["detail_url"]=meta["detail_url"]
            item["tourist_spots"]=",".join(tourist_spots)
            item["destination_place"]= meta["title"].split("+")[0] if meta["title"] != "" else ""
            item["destination_place1"]=destination_place1
            item["day_number"]=re.search(r'\d+æ—¥\d+æ™š', meta["title"]).group(0) if re.search(r'\d+æ—¥\d+æ™š', meta["title"]) else ""
            item["tourist_spots_number"]=len(tourist_spots)
            yield item
        except Exception as error:
            self.logger.error(f"æ•°æ®å…¥åº“å‡ºç°é”™è¯¯ï¼Œé”™è¯¯çš„åŸå› æ˜¯{error}")
        # print(response.meta)
            
            
        
        